# VisualStudio-EmscriptenTools

This project is a major work in progress. The idea is to be able to redirect build calls through visual studio and pass them off to Emscripten tools. The initial idea and reference material came from the following location: [link](https://github.com/crosire/vs-toolsets). However, this project differs in that it builds its task to do the work and the source for the task is in this repository.

It expects that the [Emscripten SDK](https://github.com/emscripten-core/emsdk) is installed and pointed to by the *`EMSDK`* environment variable. Which will manually have to be added. If normal installation instructions were followed, then EMSDK should point to the _root_ directory and the upstream directory should be located at `$(EMSDK)\upstream`.

## CMake

The Toolset can be selected either in the GUI or the command line. 
With the GUI select the generator `Visual Studio 16 2019`, then fill in `Emscripten` for the platform generator and `emsdk` for the toolset. Alternatively for the command line, use the -G, -A and -T options respectively.

Settings that have been converted from [settings.js](https://github.com/emscripten-core/emscripten/blob/main/src/settings.js) will be stored in the project file in a global scope. Therefore, in order to set the property during the CMake generation stage you would use the VS_GLOBALS_xxx target property.

For example:

```cmake
set_target_properties(${TargetName} PROPERTIES VS_GLOBAL_EmVerbose true)
set_target_properties(${TargetName} PROPERTIES VS_GLOBAL_EmSDLVersion 2)
```

Then during build the set properties would be passed as a `-s` switch.

## ProjectType - Application

Overrides the the standard application `ConfigurationType` tag in the project file then uses the the
EmCxx and EmLink tasks to call emcc.bat and em++.bat on the source file.

The [WAVM](https://github.com/WAVM/WAVM) virtual machine is also referenced internally to execute the output _.wasm_ file with the local windows debugger. WAVM needs to be installed separately and placed in the `$(EMSDK)\upstream\bin` folder.

### CMake - Application

For executables, it needs to have the suffix property changed in order to correctly output a wasm file.
This is because the `TargetExt` property generated by CMake will be `.exe` 

```cmake
add_executable(${TargetName} ...)
set_target_properties(${TargetName} PROPERTIES SUFFIX .wasm)
```

## ProjectType - HTMLApplication

Adds HTMLApplication as a possible value for the `ConfigurationType` tag in the project file.

The `TargetExt` is set to `.html`. Emscripten will output the `.html, .js and .wasm` files needed to run it. By default it uses emrun.bat to start the localhost server and run the embedded .wasm file.

### CMake - HTMLApplication

It needs to have the suffix property changed in order to correctly output a html file.
Since it is a custom configuration type, the `VS_CONFIGURATION_TYPE` must be set so that CMake will generate the correct type of project.

```cmake
add_executable(${TargetName} ...)
set_target_properties(${TargetName} PROPERTIES SUFFIX .html)
set_target_properties(${TargetName} PROPERTIES VS_CONFIGURATION_TYPE HTMLApplication)

```

## ProjectType - StaticLibrary

Overrides the the standard static library `ConfigurationType` tag in the project file then uses the the
EmCxx and EmAr tasks to build the static library.

## ProjectType - JavaScriptApplication

TODO

## Utilities

### **[clean.bat](clean.bat)**

Calls **python [BuildTools/DeleteFiles.py](BuildTools/DeleteFiles.py)**
The script will load the contents of .gitignore and delete matches from the filesystem.

### **[install.bat](install.bat)**

Calls **python [BuildTools/Install.py](BuildTools/Install.py)**

Which will attempt to copy the task and Toolset directory to the VisualStudio toolset directory.
It expects that the environment variable `VS2019INSTALLDIR` is defined.

It also accepts test arguments:

+ test01 - Plain MSBuild scripts
+ test02, test03 - CMake generate scripts.
+ test04 Is a manually created project.

If this script fails:

+ Check that there are no projects open that are using the toolset.
+ Check user permissions on the `%VS2019INSTALLDIR%\MSBuild\Microsoft\VC\v160\Platforms\` directory.
